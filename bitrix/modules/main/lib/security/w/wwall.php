<? namespace Bitrix\Main\Security\W;$GLOBALS['____1129117211']= array(base64_decode('d'.'Gl'.'tZQ'.'=='),base64_decode('dGlt'.'ZQ=='),base64_decode('anNvbl9kZWNvZGU='),base64_decode('YXJyYXlfbWVy'.'Z2U='),base64_decode('a'.'m9pb'.'g=='),base64_decode('am9'.'pbg='.'='),base64_decode('am9pbg'.'=='),base64_decode('Y'.'X'.'J'.'y'.'YXlfc'.'G9w'),base64_decode(''.'YXJyYXlfc2hpZ'.'nQ'.'='),base64_decode(''.'YXJyYXlfc2hpZnQ='),base64_decode(''.'YXJ'.'yYXlf'.'c2'.'h'.'pZ'.'nQ='),base64_decode(''.'YX'.'Jy'.'YXlfc2hpZn'.'Q='),base64_decode('YX'.'JyY'.'X'.'lfb'.'W'.'VyZ2U='),base64_decode('aXNfY'.'XJy'.'Y'.'Xk='),base64_decode('YX'.'JyYXlfb'.'WV'.'yZ'.'2'.'U='),base64_decode('a'.'W5'.'fYXJ'.'yY'.'Xk'.'='),base64_decode('aW5fYX'.'J'.'yY'.'Xk='),base64_decode('aW'.'5f'.'YX'.'Jy'.'YXk='),base64_decode('aW5f'.'YXJyYXk='),base64_decode('aW5fYX'.'J'.'yY'.'Xk'.'='),base64_decode('d'.'Gl'.'tZQ='.'='),base64_decode('dGl'.'tZQ=='),base64_decode('YXJy'.'YXlfbWFw'),base64_decode(''.'Z2V0X2'.'xvYWRl'.'ZF'.'9leHRlbn'.'Np'.'b25z'),base64_decode(''.'anN'.'v'.'b'.'l9lbmNvZGU='),base64_decode('anNv'.'bl9l'.'bmNvZGU='),base64_decode('cGhw'.'dmVy'.'c2l'.'vbg'.'=='),base64_decode('a'.'nNvbl9l'.'bmNvZG'.'U='),base64_decode(''.'am9pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___1462276303')){function ___1462276303($_920456655){static $_763859522= false; if($_763859522 == false) $_763859522=array('V'.'1dB'.'T'.'ExfTE9DSw'.'==',''.'c2V'.'jdX'.'JpdHk=','REFUQQ==','eyI'.'=','V1dBT'.'Ex'.'fTE9DS'.'w==','c2Vj'.'d'.'XJpdHk=',''.'U0VDVVJJ'.'V'.'F'.'lfV'.'1dBTE'.'xfR'.'VhDRVBU'.'SU'.'9O','Rk'.'F'.'J'.'TF'.'9D'.'SEVD'.'S0l'.'ORw==','Q2FuIG5vdCBle'.'G'.'Vj'.'d'.'XRl'.'IH'.'d3YWxsI'.'HJ'.'1bGV'.'zOiA=',''.'IFRyYW'.'NlO'.'iA'.'=','UkVRVUVTVF9V'.'Ukk=','a2V5cw='.'=','dmFs'.'dWVz','U0VDVVJJVF'.'lfV'.'1dBTEx'.'f'.'TU9ESUZZ','L'.'g==','U0VDV'.'VJJVF'.'l'.'fV'.'1dBTE'.'x'.'f'.'VU5TRVQ=','Lg'.'==','U0VDV'.'V'.'J'.'JVF'.'lfV1dBTE'.'xfRVhJVA==','Lg==','Z2'.'xvY'.'m'.'Fs',''.'a2V5cw==','dmFsdWVz','Z2V0','Z'.'2V'.'0','cG'.'9'.'zdA==','cG9zdA==',''.'Y29va2ll','Y29va2ll','cmVxdWV'.'zdA'.'==','cmVxdWVzdA==','Z2xvYmF'.'s','Z'.'2xvYmF'.'s','bWFpbl'.'9zZWM=','V1'.'dBTEx'.'fQUNUVU'.'FMS'.'VpFX1JV'.'T'.'EVT',''.'dg==','d'.'mVyc2lvb'.'g==','aQ==','a'.'XNJbnN0Y'.'WxsZW'.'Q'.'=','d'.'g'.'==','aW5p',''.'bW9kdWxlcw='.'=','b'.'GljZW5zZQ='.'=',''.'cG'.'hw','dg==','ZXh0','c2VjdXJp'.'d'.'Hk=','ZGI=',''.'d'.'HlwZQ==','ZGI=','dm'.'Vy'.'c2lv'.'bg==','ZGI=','dHlwZQ==',''.'ZGI=','dHlwZ'.'Q==',''.'dmVyc2lvbg==','ZG'.'I=',''.'dmVyc2lvbg==','ZW'.'52'.'aX'.'Jv'.'bm'.'1lbnQ=','d'.'m1fdmVyc2lvbg='.'=','dm0=','dg='.'=','ZW'.'52aXJvbm'.'1lb'.'nQ=','dm1fd'.'mV'.'yc2lvbg='.'=','c29ja2V0VGltZW91dA==','c3Ry'.'ZWF'.'t'.'VGlt'.'ZW'.'91dA==','KC'.'c=','ZGF0'.'YQ==','JywgJw==',''.'bW9kdWxl','JywgJw='.'=','bW9kdWx'.'lX'.'3Zlc'.'nNpb24'.'=',''.'Jy'.'k'.'=','L'.'CA=',''.'U0VDVVJJ'.'VFlfV1d'.'BTEx'.'fRVh'.'DRVBU'.'SU9O','bW'.'F'.'p'.'bg==',''.'R'.'k'.'FJTF9SR'.'U'.'ZSRV'.'NISU5H','Q2FuIG5vd'.'CByZ'.'WZ'.'yZX'.'NoIHd3YWx'.'sI'.'HJ1bGV'.'zOiA'.'=',''.'IFRyYWNlOiA=','ZGF0YQ==','eyI=','LS0tL'.'S1CRU'.'dJTiBQVUJMSUMg'.'S'.'0VZLS'.'0tLS0=','C'.'k1JSUJJ'.'akFOQ'.'mdrcWhra'.'Uc'.'5'.'dzBCQV'.'FFRkFB'.'T0'.'NBUTh'.'BT'.'UlJQkNn'.'S0N'.'B'.'U'.'UVBcTh'.'R'.'RT'.'BIam'.'1ISl'.'VTdFdW'.'Nm4'.'wemEKUlZvTHgwMkt'.'6Y'.'mZyYlMvU'.'DZzV2'.'F4VHp3O'.'FNlR1R0YlRDT3JwS'.'Gk1UUY2T1J'.'5alov'.'W'.'Hh6L0t'.'MVT'.'FHYm9mOUNaMw'.'o0ej'.'d'.'Ta3FVdDY'.'2'.'a'.'WJ'.'Ydk9GQ'.'ng0Zncv'.'Q'.'VBQUkdEcXRtMG5EM2Z'.'nR3N1'.'M1JlUGd'.'3M'.'jl'.'pOCt2bTdt'.'dEJLSl'.'VZbDRyClZwY'.'jZzZlpF'.'VDl'.'LRWI2VDFIRF'.'ltRXZ'.'jMWhx'.'L2lpdXl4TH'.'J'.'aWmk'.'1UT'.'ZVZm'.'Y0VUV2VEk'.'rNjhzc0Z'.'Sa1Erb3d'.'UUnkKZU'.'9JTWJ'.'GaE0'.'vVVR'.'tZl'.'ZZYlRSRnkyb1VRO'.'FdN'.'emE'.'ybko1U2Foemkx'.'VU'.'tPM'.'WpBalhUUFJyemM'.'3'.'QWp1NjM'.'5'.'ajFPMA'.'p'.'wcHF'.'m'.'bTV'.'4Z'.'1d'.'sRkFKa0h'.'RVGd'.'iZGQ'.'1Q'.'V'.'dxREZ'.'Ra3Q5SE'.'trWStUbm'.'ZCT'.'EdWT'.'XZWeVB3VEhO'.'V1F'.'Z'.'QXc0eHBnL3dBClp3SURBUUFCCi0'.'tLS0t'.'RU5E'.'I'.'F'.'BVQkxJQyBLRVktLS0'.'t'.'LQ==');return base64_decode($_763859522[$_920456655]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_2031990558= 'https://wwall.bitrix.info/rules.php'; protected $_1667219081= true; public function handle(){ try{  $_792383308= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_792383308)){ return;}  $_1355669145= Cache::createInstance(); $_989475680= false; if($_1355669145->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_673594768= $_1355669145->getVars(); if($GLOBALS['____1129117211'][0]()- $_673594768> round(0+20)){  $_1447986242= Application::getConnection(); $_155464534= RuleRecordTable::getTableName(); $_1447986242->truncateTable($_155464534); RuleRecordTable::cleanCache(); $_1355669145->clean(___1462276303(0), ___1462276303(1));}} elseif($_1355669145->startDataCache()){  $_1355669145->endDataCache($GLOBALS['____1129117211'][1]()); $_989475680= true;} foreach($_792383308 as $_1857541961){ $_728597914= new PublicKeyCipher; $_2054288448= $_728597914->decrypt($_1857541961[___1462276303(2)], static::__669874372()); if(!str_starts_with($_2054288448, ___1462276303(3))){ continue;} $_1675075363= $GLOBALS['____1129117211'][2]($_2054288448, true); if(!empty($_1675075363)){ $_1076395012= Rule::make($_1675075363); $_632109298= $this->handleRule($_1076395012); $this->applyHandlingResults($_632109298);}}  if($_989475680){ $_1355669145->clean(___1462276303(4), ___1462276303(5));}} catch(\Throwable $_1063047568){ $this->logEvent( ___1462276303(6), ___1462276303(7), ___1462276303(8). $_1063047568->getMessage(). ___1462276303(9). $_1063047568->getTraceAsString());}}  public function handleRule(Rule $_1076395012): array{ $_632109298=[]; if($_1076395012->matchPath($_SERVER[___1462276303(10)])){  $_1713847982= $this->getContextElements($_1076395012->getContext()); foreach($_1713847982 as $_350326091 => &$_532311821){ $_632109298= $GLOBALS['____1129117211'][3]($_632109298, $this->recursiveContextKeyHandle($_350326091, $_532311821,[], $_1076395012));}} return $_632109298;}  public function applyHandlingResults(array $_632109298){ $_1713847982= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_632109298 as $_1939539897){ $_532311821=& $_1713847982[$_1939539897->getContextName()]; $_1718433382= $_1939539897->getRuleResult(); $_1076395012= $_1939539897->getRule(); if($_1718433382 instanceof ModifyResult){ if($_1076395012->getProcess() === ___1462276303(11)){  static::rewriteContextKey( $_1939539897->getContextName(), $_532311821, $_1939539897->getContextKey(), $_1718433382->getCleanValue());} elseif($_1076395012->getProcess() === ___1462276303(12)){ static::rewriteContextValue( $_1939539897->getContextName(), $_532311821, $_1939539897->getContextKey(), $_1718433382->getCleanValue());} $this->logEvent( ___1462276303(13), $_1939539897->getContextName(), $GLOBALS['____1129117211'][4](___1462276303(14), $_1939539897->getContextKey()));} elseif($_1718433382 instanceof CheckResult &&!$_1718433382->isSuccess()){ if($_1718433382->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1939539897->getContextName(), $_532311821, $_1939539897->getContextKey(),); $this->logEvent( ___1462276303(15), $_1939539897->getContextName(), $GLOBALS['____1129117211'][5](___1462276303(16), $_1939539897->getContextKey()));} elseif($_1718433382->getAction() === RuleAction::EXIT){ $this->logEvent( ___1462276303(17), $_1939539897->getContextName(), $GLOBALS['____1129117211'][6](___1462276303(18), $_1939539897->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1667219081= false;} protected function rewriteContextKey($_350326091, &$_532311821, $_1260940209, $_1284703740){ $_464707375= $_1260940209;  $GLOBALS['____1129117211'][7]($_464707375); $_464707375[]= $_1284703740; if($_350326091 === ___1462276303(19)){ $_880353181= $GLOBALS['____1129117211'][8]($_1260940209); $GLOBALS['____1129117211'][9]($_464707375); if(empty($_1260940209)){ $GLOBALS[$_1284703740]= $GLOBALS[$_880353181]; unset($GLOBALS[$_880353181]);} else{ $_532311821=& $GLOBALS[$_880353181]; $_687223091= ArrayHelper::getByNestedKey($_532311821, $_1260940209);  ArrayHelper::setByNestedKey($_532311821, $_464707375, $_687223091);  ArrayHelper::unsetByNestedKey($_532311821, $_1260940209);}} else{ $_687223091= ArrayHelper::getByNestedKey($_532311821, $_1260940209);  ArrayHelper::setByNestedKey($_532311821, $_464707375, $_687223091);  ArrayHelper::unsetByNestedKey($_532311821, $_1260940209);}} protected function rewriteContextValue($_350326091, &$_532311821, $_71600349, $_687223091){ if($_350326091 === 'global'){ $_880353181= $GLOBALS['____1129117211'][10]($_71600349); if(empty($_71600349)){ $GLOBALS[$_880353181]= $_687223091;} else{ $_532311821=& $GLOBALS[$_880353181]; ArrayHelper::setByNestedKey($_532311821, $_71600349, $_687223091);}} else{  ArrayHelper::setByNestedKey($_532311821, $_71600349, $_687223091);}} protected function unsetContextValue($_350326091, &$_532311821, $_71600349){ if($_350326091 === 'global'){ $_880353181= $GLOBALS['____1129117211'][11]($_71600349); if(empty($_71600349)){ unset($GLOBALS[$_880353181]);} else{ $_532311821=& $GLOBALS[$_880353181]; ArrayHelper::unsetByNestedKey($_532311821, $_71600349);}} else{ ArrayHelper::unsetByNestedKey($_532311821, $_71600349);}}  protected function recursiveContextKeyHandle(string $_350326091, array &$_532311821, array $_1262852290, Rule $_1076395012): array{  $_632109298=[]; foreach($_532311821 as $_1870630987 => $_687223091){ $_71600349= $GLOBALS['____1129117211'][12]($_1262852290,[$_1870630987]); if($_1076395012->matchKey($_71600349)){  if($_1076395012->getProcess() === ___1462276303(20)){ $_1718433382= $_1076395012->evaluate($_1870630987);} elseif($_1076395012->getProcess() === ___1462276303(21)){ $_1718433382= $_1076395012->evaluateValue($_687223091);}  if(!empty($_1718433382) && $_1718433382 instanceof RuleResult){ $_632109298[]= new HandlingResult($_350326091, $_71600349, $_1718433382, $_1076395012);}}  if($GLOBALS['____1129117211'][13]($_687223091)){ $_632109298= $GLOBALS['____1129117211'][14]($_632109298, $this->recursiveContextKeyHandle( $_350326091, $_532311821[$_1870630987], $_71600349, $_1076395012));}} return $_632109298;} protected function getContextElements(array $_1545826287){ $_2142278391=[]; if($GLOBALS['____1129117211'][15](___1462276303(22), $_1545826287, true)){ $_2142278391[___1462276303(23)]= &$_GET;} if($GLOBALS['____1129117211'][16](___1462276303(24), $_1545826287, true)){ $_2142278391[___1462276303(25)]= &$_POST;} if($GLOBALS['____1129117211'][17](___1462276303(26), $_1545826287, true)){ $_2142278391[___1462276303(27)]= &$_COOKIE;} if($GLOBALS['____1129117211'][18](___1462276303(28), $_1545826287, true)){ $_2142278391[___1462276303(29)]= &$_REQUEST;} if($GLOBALS['____1129117211'][19](___1462276303(30), $_1545826287, true)){ $_2142278391[___1462276303(31)]= $GLOBALS;} return $_2142278391;} public static function refreshRules(){ try{ $_850865026= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1129117211'][20]()- $_850865026)< static::CACHE_RULES_TTL){ return;} Option::set(___1462276303(32), ___1462276303(33), $GLOBALS['____1129117211'][21]()); $_1054560468= null;  $_767469368= $GLOBALS['____1129117211'][22](function($_1129328598){ return[___1462276303(34) => $_1129328598[___1462276303(35)], ___1462276303(36) => (int) $_1129328598[___1462276303(37)]];}, ModuleManager::getModulesFromDisk());  $_899599416=[]; foreach($GLOBALS['____1129117211'][23]() as $_886273909){ $_1229539767= new ReflectionExtension($_886273909); $_899599416[$_886273909]=[ ___1462276303(38) => $_1229539767->getVersion(), ___1462276303(39) => $_1229539767->getINIEntries()];} $_1377204809=[ ___1462276303(40) => $GLOBALS['____1129117211'][24]($_767469368), ___1462276303(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1462276303(42) => $GLOBALS['____1129117211'][25]([ ___1462276303(43) => $GLOBALS['____1129117211'][26](), ___1462276303(44) => $_899599416])]; if(Loader::includeModule(___1462276303(45))){ $_506441059= CSecuritySystemInformation::getSystemInformation(); if(isset($_506441059[___1462276303(46)][___1462276303(47)]) && isset($_506441059[___1462276303(48)][___1462276303(49)])){ $_1377204809[___1462276303(50)]=[ ___1462276303(51) => $_506441059[___1462276303(52)][___1462276303(53)], ___1462276303(54) => $_506441059[___1462276303(55)][___1462276303(56)]];} if(isset($_506441059[___1462276303(57)][___1462276303(58)])){ $_1377204809[___1462276303(59)]=[___1462276303(60) => $_506441059[___1462276303(61)][___1462276303(62)]];}}  $_1934684074= new HttpClient([ ___1462276303(63) => round(0+5), ___1462276303(64) => round(0+1+1+1+1+1)]); $_2012892813= $_1934684074->post( static::$_2031990558, $_1377204809); if($_1934684074->getStatus() == round(0+40+40+40+40+40) &&!empty($_2012892813)){ $_1054560468= Json::decode($_2012892813);}  if($_1054560468 !== null){ $_1447986242= Application::getConnection(); $_155464534= RuleRecordTable::getTableName(); if(!empty($_1054560468)){ foreach($_1054560468 as $_166894811){ if(!static::checkRuleSign($_166894811)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1129117211'][27]($_166894811));}}}  $_1447986242->truncateTable($_155464534);  if(!empty($_1054560468)){ $_1925707031=[]; foreach($_1054560468 as $_166894811){ $_1925707031[]= ___1462276303(65). $_1447986242->getSqlHelper()->forSql($_166894811[___1462276303(66)]). ___1462276303(67). $_1447986242->getSqlHelper()->forSql($_166894811[___1462276303(68)]). ___1462276303(69). $_1447986242->getSqlHelper()->forSql($_166894811[___1462276303(70)]). ___1462276303(71);} $_1290929823= $GLOBALS['____1129117211'][28](___1462276303(72), $_1925707031);  $_1447986242->query("INSERT INTO {$_155464534} (DATA, MODULE, MODULE_VERSION) VALUES {$_1290929823}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1063047568){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1462276303(73), ___1462276303(74), ___1462276303(75), ___1462276303(76). $_1063047568->getMessage(). ___1462276303(77). $_1063047568->getTraceAsString());}} protected static function checkRuleSign($_1076395012){ $_728597914= new PublicKeyCipher; $_1675075363= $_728597914->decrypt($_1076395012[___1462276303(78)], static::__669874372()); return str_starts_with($_1675075363, ___1462276303(79));} private static function __669874372(){ $_876365364= ''; $_876365364 .= ___1462276303(80); $_876365364 .= ___1462276303(81); return $_876365364;} protected function logEvent($_1251899348, $_1407517029, $_944385860){ if($this->_1667219081){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1251899348, 'main', $_1407517029, $_944385860);}}}?>